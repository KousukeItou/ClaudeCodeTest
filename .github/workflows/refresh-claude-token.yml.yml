name: Refresh Claude API token
on:
  # 55 åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆæœ‰åŠ¹æœŸé™ 60 min ã‚’æƒ³å®šï¼‰
  schedule:
    - cron:  '*/55 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      # GitHub Secrets ã«ç”¨æ„ã—ã¦ãŠã â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
      CLAUDE_CLIENT_ID:     ${{ secrets.CLAUDE_CLIENT_ID }}
      CLAUDE_CLIENT_SECRET: ${{ secrets.CLAUDE_CLIENT_SECRET }}
      #   ã“ã“ã¾ã§
    steps:
      - name: Check out (å¿…è¦ãªã‚‰)
        uses: actions/checkout@v4

      - name: ğŸ”„ Claude ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ç™ºè¡Œ
        id: refresh
        run: |
          new_token=$(curl -s -X POST https://api.anthropic.com/oauth/token \
            -d grant_type=refresh_token \
            -d refresh_token=$CLAUDE_REFRESH_TOKEN \
            -u "$CLAUDE_CLIENT_ID:$CLAUDE_CLIENT_SECRET" \
            | jq -r .access_token)
          echo "token=$new_token" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------------------
      # â†“ ã“ã“ãŒ â€œGitHub Secrets ã‚’ä¸Šæ›¸ãâ€ ã™ã‚‹éƒ¨åˆ†
      #    gh CLI ã‚’ä½¿ã†ã®ãŒä¸€ç•ªãƒ©ã‚¯
      # --------------------------------------------------------------
      - name: ğŸš€ GitHub ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä¸Šæ›¸ã
        # gh CLI ã¯ 'GITHUB_TOKEN' ã§ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ›´æ–°æ¨©é™ãŒãªã„ãŸã‚ã€
        # repo å…¨æ¨© (ã¾ãŸã¯ fine-grained ã§ secrets:write) ã® PAT ã‚’åˆ¥é€”ç”¨æ„
        env:
          GH_PAT_FOR_SECRETS: ${{ secrets.GH_PAT_FOR_SECRETS }}
          NEW_TOKEN: ${{ steps.refresh.outputs.token }}
        run: |
          echo "$GH_PAT_FOR_SECRETS" | gh auth login --with-token
          printf '%s' "$NEW_TOKEN" | gh secret set CLAUDE_API_TOKEN -R "$GITHUB_REPOSITORY" --app actions