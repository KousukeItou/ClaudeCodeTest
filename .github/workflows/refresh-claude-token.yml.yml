name: Refresh Claude API token

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒˆãƒªã‚¬ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: '*/55 * * * *'        # 55 åˆ†ã”ã¨ï¼ˆæœ‰åŠ¹æœŸé™ 60 åˆ†æƒ³å®šï¼‰
  workflow_dispatch:              # Actions ã‚¿ãƒ–ã® Run workflow ãƒœã‚¿ãƒ³

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº‹å‰ç¢ºèª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Settings â†’ Secrets â†’ Actions ã«ä¸‹è¨˜ 4 ã¤ã‚’ä¿å­˜ã—ã¦ãŠã
# 1) CLAUDE_REFRESH_TOKEN      â† ä¸€åº¦ç™ºè¡Œã—ãŸã‚‰å›ºå®š
# 2) CLAUDE_CLIENT_ID
# 3) CLAUDE_CLIENT_SECRET
# 4) GH_PAT_FOR_SECRETS        â† repo or secrets:write æ¨©é™ä»˜ã PAT
#    ï¼ˆã“ã® PAT ã‚’ä½¿ã£ã¦ GitHub ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä¸Šæ›¸ãã™ã‚‹ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      # Claude å´
      CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
      CLAUDE_CLIENT_ID:     ${{ secrets.CLAUDE_CLIENT_ID }}
      CLAUDE_CLIENT_SECRET: ${{ secrets.CLAUDE_CLIENT_SECRET }}
      # gh CLI ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
      GH_TOKEN:             ${{ secrets.GH_PAT_FOR_SECRETS }}

    steps:
      # 1) æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
      - name: ğŸ”„ Fetch new Claude access token
        id: claude
        shell: bash
        run: |
          set -euo pipefail
          response=$(curl -sS -X POST https://api.anthropic.com/oauth/token \
            -d grant_type=refresh_token \
            -d refresh_token="$CLAUDE_REFRESH_TOKEN" \
            -u "$CLAUDE_CLIENT_ID:$CLAUDE_CLIENT_SECRET")

          ACCESS_TOKEN=$(echo "$response" | jq -r '.access_token')
          EXPIRES_IN=$(echo "$response" | jq -r '.expires_in')   # ä¾‹: 3600
          # å¤±åŠ¹æ™‚åˆ» (ISO8601) ã‚’ç®—å‡º
          EXPIRES_AT=$(date -u -d "@$(( $(date +%s) + EXPIRES_IN ))" '+%Y-%m-%dT%H:%M:%SZ')

          echo "::add-mask::$ACCESS_TOKEN"
          echo "access=$ACCESS_TOKEN" >>"$GITHUB_OUTPUT"
          echo "expires=$EXPIRES_AT"  >>"$GITHUB_OUTPUT"

      # 2) ãƒªãƒã‚¸ãƒˆãƒªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›¸ãæ›ãˆ
      - name: ğŸš€ Update repo secrets
        env:
          ACCESS:  ${{ steps.claude.outputs.access }}
          EXPIRES: ${{ steps.claude.outputs.expires }}
        run: |
          set -euo pipefail
          gh secret set CLAUDE_ACCESS_TOKEN --app actions --body "$ACCESS"
          gh secret set CLAUDE_EXPIRES_AT   --app actions --body "$EXPIRES"
          echo "âœ… Secrets updated: CLAUDE_ACCESS_TOKEN / CLAUDE_EXPIRES_AT"