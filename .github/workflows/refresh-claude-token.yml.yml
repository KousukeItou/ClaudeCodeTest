name: Refresh Claude API token

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 55 ÂàÜ„Åî„Å®„Å´Ëá™ÂãïÂÆüË°å Ôºã ÊâãÂãïËµ∑Âãï (Actions „Çø„Éñ ‚Üí Run workflow)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
on:
  schedule:
    - cron: '*/55 * * * *'
  workflow_dispatch:

jobs:
  refresh:
    runs-on: ubuntu-latest

    # ---------------------------------------------------------
    # „Ç∞„É≠„Éº„Éê„É´Áí∞Â¢ÉÂ§âÊï∞
    #   - Claude ÂÅ¥„ÅÆ„É™„Éï„É¨„ÉÉ„Ç∑„É•„Éà„Éº„ÇØ„É≥ & „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊÉÖÂ†±
    #   - PAT (secrets ÂÜô„ÅóÊõø„ÅàÁî®) „Çí GH_TOKEN „Å®„Åó„Å¶Ê∏°„Åô
    # ---------------------------------------------------------
    env:
      CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
      CLAUDE_CLIENT_ID:     ${{ secrets.CLAUDE_CLIENT_ID }}
      CLAUDE_CLIENT_SECRET: ${{ secrets.CLAUDE_CLIENT_SECRET }}
      GH_TOKEN:             ${{ secrets.GH_PAT_FOR_SECRETS }}   # ‚Üê gh CLI „ÅåËá™ÂãïË™çË®º

    steps:
      # 1. Claude „ÅÆÊñ∞„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
      - name: üîÑ Get new Claude access token
        id: refresh
        run: |
          set -eo pipefail
          resp=$(curl -sS -X POST https://api.anthropic.com/oauth/token \
            -d grant_type=refresh_token \
            -d refresh_token="$CLAUDE_REFRESH_TOKEN" \
            -u "$CLAUDE_CLIENT_ID:$CLAUDE_CLIENT_SECRET")
          NEW_TOKEN=$(echo "$resp" | jq -r .access_token)
          echo "::add-mask::$NEW_TOKEN"            # „Éû„Çπ„ÇØ„Åó„Å¶„É≠„Ç∞„Å´Êºè„Çâ„Åï„Å™„ÅÑ
          echo "token=$NEW_TOKEN" >> "$GITHUB_OUTPUT"

      # 2. GitHub „Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„Çí‰∏äÊõ∏„Åç
      - name: üöÄ Update GitHub secret CLAUDE_API_TOKEN
        env:
          NEW_TOKEN: ${{ steps.refresh.outputs.token }}
        run: |
          set -eo pipefail
          gh secret set CLAUDE_API_TOKEN \
            --repo "$GITHUB_REPOSITORY" \
            --app actions \
            --body "$NEW_TOKEN"
          echo "‚úÖ CLAUDE_API_TOKEN updated successfully"